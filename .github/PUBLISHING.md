# Publishing Guide: CI/CD with GitHub Actions & npm OIDC

This document explains how to set up automated publishing to npm using GitHub Actions with OIDC (OpenID Connect) trusted publishing.

## Overview

The CI/CD pipeline (`.github/workflows/publish.yml`) automates:

- ✅ Running tests on every push and PR
- ✅ Running linting and validation
- ✅ Building the project
- ✅ Publishing to npm on release creation
- ✅ Creating GitHub release assets

## Prerequisites

1. **GitHub Repository**: Must be public for OIDC to work
2. **npm Account**: Need access to manage publishing settings
3. **Package**: Must be published at least once manually

## Setup Instructions

### Step 1: Publish v1.0.7 Manually (One-Time Setup)

First, publish the current version to npm manually to establish the package:

```bash
cd /Users/john_renaldi/claude-code-projects/google-workspace-mcp
npm publish --otp=<YOUR_6_DIGIT_CODE>
```

This creates the package on npm registry and enables OIDC configuration.

### Step 2: Configure OIDC Trusted Publisher on npm

Visit https://www.npmjs.com/ and:

1. **Log in** to your npm account
2. Go to **Account Settings** → **Publishing**
3. Click **Configure OIDC trusted publishers**
4. Click **Add a new trusted publisher**
5. Select:
   - **Where is the OIDC token coming from?**: GitHub Actions
   - **What kind of trusted publisher?**: GitHub repository
6. Fill in:
   - **GitHub repository owner** (username): `jrenaldi79`
   - **GitHub repository name**: `google-workspace-mcp`
   - **GitHub environment** (optional): leave blank or set to `publish`
7. Click **Add trusted publisher**

### Step 3: Verify Configuration

Check that the trusted publisher is configured correctly:

```bash
npm profile get
```

You should see the GitHub repository listed as a trusted publisher.

## Publishing a New Release

### Option A: Using GitHub Web Interface (Recommended)

1. Go to your GitHub repository
2. Click **Releases** → **Draft a new release**
3. Click **Choose a tag** and create a new tag matching your version (e.g., `v1.0.8`)
4. Set:
   - **Tag version**: `v1.0.8` (must match `package.json` version)
   - **Release title**: `Release v1.0.8` or description
   - **Description**: Add release notes
5. Click **Publish release**

The GitHub Actions workflow will automatically:

- ✅ Verify package version matches tag
- ✅ Run tests
- ✅ Run linting
- ✅ Build the project
- ✅ Publish to npm
- ✅ Upload dist files as release assets

### Option B: Using Git Command Line

```bash
# Update version in package.json
npm version patch  # or minor, major

# This automatically:
# - Updates package.json
# - Creates a git commit
# - Creates a git tag
# - Pushes to GitHub

# GitHub Actions will detect the tag and publish
```

### Option C: Manual Release + Workflow

```bash
# Update version
npm version minor --no-git-tag-version

# Commit
git add package.json
git commit -m "Bump version to 1.0.8"
git push origin master

# Create release on GitHub (via web interface)
# Tag: v1.0.8
# Workflow will automatically publish
```

## Workflow Details

### Triggers

The CI/CD pipeline runs on:

| Event                 | Behavior                                             |
| --------------------- | ---------------------------------------------------- |
| **Push to master**    | Run tests & linting only                             |
| **Pull Request**      | Run tests & linting                                  |
| **Release Published** | Run tests, lint, validate, build, **publish to npm** |

### Publishing Job Requirements

The `publish` job only runs when:

1. `test` job passes (all tests pass)
2. `validate` job passes (pre-publish checks pass)
3. Event is a release creation (`github.event_name == 'release'`)
4. Release action is 'published'

### Version Verification

The workflow verifies that:

- Package version in `package.json` matches the release tag
- Example: Tag `v1.0.8` must match `package.json` version `1.0.8`

If versions don't match, the publish job fails as a safety check.

## Environment Variables & Secrets

The workflow uses:

| Variable          | Source                     | Purpose                      |
| ----------------- | -------------------------- | ---------------------------- |
| `id-token: write` | GitHub Actions Permissions | Enable OIDC token generation |
| `GITHUB_TOKEN`    | GitHub                     | Create release assets        |

**✅ OIDC Trusted Publishing is Fully Enabled**:

- ❌ NO `NPM_TOKEN` secret needed
- ❌ NO `NODE_AUTH_TOKEN` environment variable
- ✅ OIDC token automatically generated by GitHub Actions
- ✅ npm CLI automatically uses OIDC for authentication
- ✅ Provenance attestations automatically published

## How OIDC Trusted Publishing Works

1. **GitHub Actions generates OIDC token** when `id-token: write` permission is set
2. **npm CLI receives the token** via GitHub's OIDC provider
3. **npm validates the token** against your configured trusted publisher (on npm.com)
4. **npm publishes the package** using the validated OIDC token
5. **Provenance attestations are automatically created** for supply chain security

**Key Security Benefits** (per [npm documentation](https://docs.npmjs.com/trusted-publishers/)):

- ✅ Short-lived tokens (valid only during workflow run)
- ✅ Cryptographically signed - cannot be reused or extracted
- ✅ No credentials stored in GitHub secrets
- ✅ Automatic provenance attestations
- ✅ Full audit trail in GitHub Actions and npm logs
- ✅ No manual token rotation needed

## Troubleshooting

### Build Fails on Push

**Problem**: Tests fail on push but you want to publish

**Solution**: Only publish job runs on release events, not on every push. Push tests failures won't block releases.

### Version Mismatch Error

**Problem**: Publish job fails with "Version mismatch"

**Solution**: Ensure the release tag matches the `package.json` version:

- Release tag: `v1.0.8`
- package.json: `"version": "1.0.8"`

### NPM Publish Fails with 404

**Problem**: Workflow tries to publish but gets 404 error

**Solution**:

1. Verify OIDC trusted publisher is configured on npm
2. Verify npm token has publish permissions
3. Run a manual publish first to create the package:
   ```bash
   npm publish --otp=<CODE>
   ```

### OIDC Token Rejected

**Problem**: Workflow fails with "OIDC token invalid" or "Unauthorized"

**Solution**:

1. **GitHub repository must be public** (OIDC requires public repos)

   ```bash
   # Verify repo visibility on GitHub
   ```

2. **OIDC trusted publisher must be configured on npm.com**
   - Go to https://www.npmjs.com/ → Account Settings → Publishing
   - Verify the trusted publisher entry exists
   - Verify all fields match your GitHub repo

3. **Verify workflow permissions**

   ```yaml
   permissions:
     id-token: write # MUST be present
     contents: read
   ```

4. **Check npm CLI version** (1.35.0+ required)
   - Workflow automatically updates npm to latest

5. **Review GitHub Actions logs** for detailed error message

### npm Publish Fails: "Package Not Found"

**Problem**: Publish fails with 404 after OIDC setup

**Solution**:

1. **Manually publish v1.0.7 first** (one-time setup):

   ```bash
   npm publish --otp=<YOUR_CODE>
   ```

   This establishes the package on npm registry

2. **Then configure OIDC trusted publisher** on npm.com

3. **Future releases** will use OIDC automatically

## Manual Publishing (Fallback)

If the automated workflow fails, you can publish manually:

```bash
npm publish --otp=<YOUR_CODE>
```

**Note**: With OIDC configured, you can also try:

```bash
npm publish
```

(npm will attempt OIDC authentication automatically)

## Monitoring

After publishing:

1. **Check npm**: https://www.npmjs.com/package/@presto-ai/google-workspace-mcp
2. **Check GitHub Actions**: Repository → Actions tab
3. **Check GitHub Releases**: Repository → Releases
4. **Test Installation**:
   ```bash
   npm install @presto-ai/google-workspace-mcp@latest
   ```

## Security Best Practices

✅ **Recommended**:

- Use OIDC trusted publishing (no credentials stored)
- Require manual release creation (no auto-publish)
- Verify version before publishing
- Use Node.js LTS in CI/CD
- Run tests on all branches
- Cache npm dependencies

❌ **Avoid**:

- Storing npm tokens as secrets
- Auto-publishing on every commit
- Publishing without running tests
- Using old Node.js versions in CI

## References

- **[npm Trusted Publishers Documentation](https://docs.npmjs.com/trusted-publishers/)** - Official npm docs on trusted publishing
- **[npm Provenance Statements](https://docs.npmjs.com/generating-provenance-statements/)** - Automatic provenance with OIDC
- **[GitHub OIDC Documentation](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)** - GitHub Actions OIDC
- **[GitHub Actions Documentation](https://docs.github.com/en/actions)** - GitHub Actions overview
- **[npm Publishing Guide](https://docs.npmjs.com/packages-and-modules/)** - General npm publishing guide
